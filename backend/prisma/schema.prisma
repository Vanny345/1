// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users (Clients/Customers)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  cpf           String?   @unique
  dateOfBirth   DateTime?
  address       String?
  city          String?
  state         String?
  postalCode    String?
  profilePhoto  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  bookings      Booking[]
  reviews       Review[]
  notifications Notification[]
  disputes      Dispute[]

  @@index([email])
  @@index([city])
}

// Cleaners (Faxineiras)
model Cleaner {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  phone         String
  cpf           String    @unique
  dateOfBirth   DateTime
  age           Int
  region        String
  bio           String?
  photo         String?
  nationalId    String?   // For identity verification
  bankAccount   String?   // For payouts
  
  // Rating info
  averageRating Float     @default(0)
  reviewCount   Int       @default(0)
  totalBookings Int       @default(0)
  
  // üèÜ B√¥nus e Agilidade
  consecutiveFiveStars Int @default(0)    // Contador de 5 estrelas seguidas
  topCleanerBadge Boolean @default(false) // Badge TOP CLEANER ativo
  topCleanerUntil DateTime?               // Data at√© quando mant√©m badge (30 dias)
  totalBonusEarned Float @default(0)      // Total de b√¥nus ganho
  lastBonusDate DateTime?                 // Data do √∫ltimo b√¥nus
  
  // ‚è∞ Agilidade Mensal
  currentMonthCalls Int @default(0)       // Chamadas este m√™s
  currentMonthAcceptance Float @default(0) // Taxa de aceita√ß√£o
  agilityScore Float @default(0)          // Score de agilidade (0-10)
  
  // Status
  status        String    @default("active") // active, inactive, suspended, verified
  verified      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  bookings      Booking[]
  reviews       Review[]
  schedules     CleanerSchedule[]
  weekSchedules CleanerWeekDay[]
  availability  CleanerAvailability[]
  bankDetails   BankDetail?
  documents     Document[]
  notifications Notification[]
  disputes      Dispute[]
  bonuses       CleanerBonus[]
  metrics       CleanerMetrics[]

  @@index([region])
  @@index([email])
  @@index([status])
  @@index([topCleanerBadge])
}

// Cleaner Schedule - Agenda Principal (Turnos Fixos ou Flex√≠vel)
model CleanerSchedule {
  id        String   @id @default(cuid())
  cleanerId String   @unique
  cleaner   Cleaner  @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  // Tipo de agenda
  scheduleType String @default("fixed") // "fixed" (turnos) ou "flexible" (dia a dia)
  
  // Configura√ß√µes
  timeSlotDuration Int @default(120)    // minutos para cada agendamento (ex: 120 = 2h)
  minBookingInAdvance Int @default(24)  // horas antes que pode agendar
  maxBookingsPerDay Int @default(5)     // m√°ximo agendamentos por dia
  
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  weekDays CleanerWeekDay[]

  @@index([cleanerId])
  @@index([scheduleType])
}

// Cleaner Week Day - Dias da semana (Para turnos fixos)
model CleanerWeekDay {
  id        String   @id @default(cuid())
  scheduleId String
  schedule  CleanerSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  cleanerId String
  cleaner   Cleaner   @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  dayOfWeek Int      // 0=DOM, 1=SEG, 2=TER, 3=QUA, 4=QUI, 5=SEX, 6=SAB
  isWorking Boolean  @default(false)
  
  timeSlots CleanerTimeSlot[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scheduleId, dayOfWeek])
  @@index([cleanerId])
}

// Cleaner Time Slot - Hor√°rios espec√≠ficos de cada dia
model CleanerTimeSlot {
  id        String   @id @default(cuid())
  weekDayId String
  weekDay   CleanerWeekDay @relation(fields: [weekDayId], references: [id], onDelete: Cascade)
  
  startTime String   // "08:00"
  endTime   String   // "12:00"
  
  createdAt DateTime @default(now())

  @@index([weekDayId])
}

// Cleaner Availability - Disponibilidade Flex√≠vel (Para agenda dia a dia)
model CleanerAvailability {
  id        String   @id @default(cuid())
  cleanerId String
  cleaner   Cleaner  @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  date      String   // "2026-02-15"
  startTime String   // "08:00"
  endTime   String   // "18:00"
  
  isBlocked Boolean  @default(false)  // true = bloqueado (f√©rias, doen√ßa, etc)
  reason    String?                   // "f√©rias", "doen√ßa", "manuten√ß√£o"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cleanerId, date])
  @@index([cleanerId])
  @@index([date])
}

// Bookings/Agendamentos
model Booking {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  cleanerId    String
  cleaner      Cleaner  @relation(fields: [cleanerId], references: [id])
  
  // Booking details
  date         DateTime
  startTime    String
  endTime      String
  address      String
  city         String
  latitude     Float?
  longitude    Float?
  serviceType  String   // standard, deep-clean, etc
  notes        String?
  duration     Int      // in minutes
  
  // Pricing
  estimatedPrice Float
  finalPrice     Float?
  
  // Status
  status       String   @default("confirmed") // pending, confirmed, completed, cancelled, no-show
  paymentStatus String  @default("pending")   // pending, completed, refunded
  cancellationReason String?
  cancelledAt  DateTime?
  completedAt  DateTime?
  
  // Relations
  payment      Payment?
  review       Review?
  dispute      Dispute?
  history      BookingHistory[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([cleanerId])
  @@index([date])
  @@index([status])
}

// Booking History (for tracking changes)
model BookingHistory {
  id        String   @id @default(cuid())
  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  action    String   // created, updated, cancelled, completed
  details   String   // JSON string with changed fields
  createdAt DateTime @default(now())

  @@index([bookingId])
}

// Payments
model Payment {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  booking       Booking  @relation(fields: [bookingId], references: [id])
  
  // Payment details
  amount        Float
  method        String   // card, pix, boleto
  paymentGateway String // stripe, mercadopago
  transactionId String   @unique
  
  // Stripe/MercadoPago details
  stripePaymentIntentId String?
  mercadopagoPaymentId  String?
  
  status        String   @default("pending") // pending, completed, failed, refunded
  receiptUrl    String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  refundedAt    DateTime?

  @@index([bookingId])
  @@index([status])
}

// Reviews/Ratings
model Review {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  cleanerId String
  cleaner   Cleaner  @relation(fields: [cleanerId], references: [id])
  bookingId String    @unique
  booking   Booking   @relation(fields: [bookingId], references: [id])
  
  rating    Int      // 1-5
  comment   String?
  
  // Additional ratings
  punctuality Int?   // 1-5
  professionalism Int? // 1-5
  quality     Int?   // 1-5
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cleanerId])
  @@index([userId])
}

// Notifications
model Notification {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  cleanerId String?
  cleaner   Cleaner? @relation(fields: [cleanerId], references: [id], onDelete: SetNull)
  
  title     String
  message   String
  type      String   // booking_confirmed, payment_received, review_received, etc
  read      Boolean  @default(false)
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([cleanerId])
  @@index([read])
}

// Discounts/Coupons
model Discount {
  id        String   @id @default(cuid())
  code      String   @unique
  description String?
  
  discountType String // percentage, fixed
  discountValue Float
  
  minBookingAmount Float?
  maxUses       Int?
  currentUses   Int    @default(0)
  
  validFrom    DateTime
  validUntil   DateTime
  
  active       Boolean @default(true)
  createdAt    DateTime @default(now())

  @@index([code])
  @@index([validFrom])
}

// Disputes
model Dispute {
  id        String   @id @default(cuid())
  bookingId String   @unique
  booking   Booking  @relation(fields: [bookingId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  cleanerId String
  cleaner   Cleaner  @relation(fields: [cleanerId], references: [id])
  
  reason    String
  description String?
  evidence  String[] // URLs to photos/videos
  
  status    String   @default("open") // open, investigating, resolved, closed
  resolution String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  resolvedAt DateTime?

  @@index([status])
  @@index([userId])
  @@index([cleanerId])
}

// Bank Details for Payouts
model BankDetail {
  id        String   @id @default(cuid())
  cleanerId String   @unique
  cleaner   Cleaner  @relation(fields: [cleanerId], references: [id])
  
  // Dados Banc√°rios
  bankCode  String?          // Ex: 001 (BB), 033 (Santander), 237 (Bradesco)
  bankName  String?
  accountType String?        // corrente, poupan√ßa
  accountNumber String?      // N√∫mero da conta
  accountDigit  String?      // D√≠gito verificador
  accountHolderName String?  // Nome do titular
  
  // PIX
  pixKey    String?          // Chave PIX (email, cpf, phone, random)
  pixKeyType String?         // email, cpf, phone, random
  
  // Pre√ßo por Hora
  hourlyRate Float @default(75.00) // R$ 75,00 padr√£o
  
  // Dados para Transfer√™ncias
  preferredPaymentMethod String @default("pix") // pix, bankTransfer, both
  
  // Status
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Documents (for cleaner verification)
model Document {
  id        String   @id @default(cuid())
  cleanerId String
  cleaner   Cleaner  @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  type      String   // id, proof_of_address, certification
  url       String
  verified  Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cleanerId])
}

// Cleaner Bonus - B√¥nus por Performance
model CleanerBonus {
  id        String   @id @default(cuid())
  cleanerId String
  cleaner   Cleaner  @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  // Valor e motivo
  amount    Float    // R$ 100,00 geralmente
  reason    String   // "10_consecutive_five_stars", "milestone_100_bookings", etc
  
  // Status de transfer√™ncia
  status    String   @default("pending") // pending, transferred, failed
  transferredAt DateTime?
  failureReason String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cleanerId])
  @@index([status])
  @@index([createdAt])
}

// Cleaner Metrics - M√©tricas de Desempenho Mensal
model CleanerMetrics {
  id        String   @id @default(cuid())
  cleanerId String
  cleaner   Cleaner  @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  // Per√≠odo
  year      Int      // 2026
  month     Int      // 1-12
  
  // Chamadas/Convites
  totalCalls Int @default(0)              // Total de chamadas/convites
  acceptedCalls Int @default(0)           // Quantas aceitou
  rejectedCalls Int @default(0)           // Quantas rejeitou
  acceptanceRate Float @default(0)        // % (ex: 93.5)
  
  // Resposta
  avgResponseTime Int @default(0)         // segundos (ex: 120 = 2min)
  
  // Conclus√£o
  completedJobs Int @default(0)
  cancelledJobs Int @default(0)
  noShowJobs Int @default(0)
  completionRate Float @default(0)        // % (ex: 100)
  
  // Avalia√ß√µes
  avgRating Float @default(0)             // ex: 4.9
  totalReviewsReceived Int @default(0)
  fiveStarReviews Int @default(0)
  
  // Score Final
  agilityScore Float @default(0)          // 0-10
  topPercentile Boolean @default(false)   // Top 5%?
  ranking Int?                             // Posi√ß√£o no ranking
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cleanerId, year, month])
  @@index([cleanerId])
  @@index([year, month])
  @@index([agilityScore])
  @@index([topPercentile])
}

// Admin Logs
model AdminLog {
  id        String   @id @default(cuid())
  action    String
  details   String   // JSON string
  createdAt DateTime @default(now())
}
